#!/usr/bin/env python
import argparse, sys 
import nucChIP
###########################################################
def getParser():
	parser = argparse.ArgumentParser(description='Computes average coverage on the array of nucleosomes surrounding TSS.')
	parser.add_argument('-tss',type=str,dest="tssData",help="Python pickle file. Database of TSS positions.")
	parser.add_argument('-nucRP',type=str,dest="nucRelPos",help="TAB file. Nucleosomes positions relative to TSS, where columns are: region_ID_name TAB distance_relative_to_TSS. If not provided, the program will look the 5 clossest nucleosomes (3/2 dwonstream/upstream) to each gene TSS. Default: 'none'",default="none")
	parser.add_argument('-nucAP',type=str,dest="nucAbsPos",help="BED file. Nucleosomes absoluto positions. Output of iNPS or DANPOS. Default: 'none'",default="none")
	parser.add_argument('-fragL',type=int,dest="fragLength",help="INT. Fragment size of the reads. If paired-end equals 0. Default: 0", default=0)
	parser.add_argument('-lower',type=int,dest="lower",help="INT. Lower insert size of paired-end reads.")
	parser.add_argument('-upper',type=int,dest="upper",help="INT. Upper insert size of paired-end reads.")
	parser.add_argument('-bam',type=str,dest="bamFile",help="BAM file. ChIP-seq reads.")
	parser.add_argument('-expr',type=str,dest="expr",help="TXT file. Expression (fpkm) per gene.")
	parser.add_argument('-o',type=str,dest="oFile",help="STR. Name of output file.")

	if len(sys.argv) == 1:
		print >> sys.stderr,parser.print_help()
		exit(0)
	return parser
###########################################################
def main():
	args = getParser().parse_args()
	tssData	= args.tssData
	nucRelPos = args.nucRelPos
	nucAbsPos = args.nucAbsPos
	bamFile = args.bamFile
	expr	= args.expr
	oFile   = args.oFile
	lower   = args.lower
	upper   = args.upper
	fragLength = args.fragLength
	####################################################
	# Excecution
	print "Getting expression data per gene"
	geneExpr = {}
	for line in open(expr,'r'):
		line = line.strip().split('\t')
		gene_id = line[0]
		fpkm	= line[5]
		geneExpr[ gene_id ] = fpkm
	if nucRelPos!="none":
		print "Getting nucleosomes array per gene"
		headerNames,nucArray = nucChIP.getNuclPerPromoter(tssData,nucRelPos)
		print "Counting reads per gene's nucleosome array"
		nucArrayCoverage = nucChIP.getProfile(75,nucArray,bamFile,fragLength,lower,upper)
		print "Saving results to output file"
		out = open(oFile,'w')
		header = ['gene_id']+headerNames+['fpkm']
		print >>out, '\t'.join(map(str,header))
		for gene_id in nucArrayCoverage:
			if gene_id in geneExpr: fpkm = geneExpr[ gene_id ]
			else:				   fpkm = 'nan'
			output =[ gene_id ] + nucArrayCoverage[gene_id] + [ fpkm ]
			print >>out, '\t'.join(map(str,output))
		out.close()
	elif nucRelPos=="none" and nucAbsPos!="none":
		print "Getting nucleosomes array per gene"
		nucArray, nucArrayDists = nucChIP.getNuclPerPromoter2(tssData,nucAbsPos)
		print "Computing coverage on gene's nucleosome array"
		nucArrayCoverage = nucChIP.getProfile(75,nucArray,bamFile,fragLength,lower,upper)
		print "Saving results to output file"
		out = open(oFile,'w')
		header = ['gene_id']+['dn2','dn1','dp1','dp2','dp3']+['cn2','cn1','cp1','cp2','cp3']+['fpkm']
		print >>out, '\t'.join(map(str,header))
		for gene_id in nucArrayCoverage:
			if gene_id in geneExpr: fpkm = geneExpr[ gene_id ]
			else:				   fpkm = 'nan'
			output =[ gene_id ] + nucArrayDists[gene_id] + nucArrayCoverage[gene_id] + [ fpkm ]
			print >>out, '\t'.join(map(str,output))
		out.close()
################################################################
if __name__ == '__main__':
	main()
